---
alwaysApply: false
---

# Implementation Plan (Telegram бот + OpenAI GPT‑5.2 + Excel) — Python

> Важно: **у каждого пункта есть статус**. Начинай работу **с первого пункта со статусом TODO** и двигайся сверху вниз.  
> Статусы: `TODO` → `IN_PROGRESS` → `DONE`.

---

## Milestone 1 — Bootstrap проекта, структура, локальный запуск (без OpenAI)

- TODO: [STATUS: TODO] Создать структуру репозитория (минимум): `src/`, `src/app/`, `src/app/bot/`, `src/app/services/`, `src/app/data/`, `src/app/storage/`, `tests/`, `scripts/`, `prompts/`, `docs/`, `data/`.
- TODO: [STATUS: TODO] Создать **.gitignore ДО первого коммита**, убедиться что `.env` и любые секреты исключены (например: `.env`, `.env.*`, `*.key`, `*.pem`, `data/*.xlsx` при необходимости).
- TODO: [STATUS: TODO] Создать `README.md` с: требованиями, локальным запуском, переменными окружения, деплоем на Railway, как обновлять Excel.
- TODO: [STATUS: TODO] Создать `pyproject.toml` (пакет `feature_summary_bot`) и настроить editable install (под `pip install -e .`).
- TODO: [STATUS: TODO] Добавить зависимости (минимум):
  - `python-telegram-bot` (webhook/polling)
  - `openai`
  - `pandas`, `openpyxl` (чтение Excel)
  - `pydantic` (валидация конфигов и данных)
  - **`python-dotenv`** (загрузка локальных переменных окружения)
  - `structlog` или `loguru` (логирование)
- TODO: [STATUS: TODO] Создать `.env.example` и описать переменные:
  - `TELEGRAM_BOT_TOKEN`
  - `OPENAI_API_KEY`
  - `OPENAI_MODEL` (по умолчанию `gpt-5.2`)
  - `EXCEL_PATH` (путь к xlsx в контейнере/на Railway)
  - `BOT_MODE` (`polling`/`webhook`)
  - `WEBHOOK_URL`, `PORT` (для webhook)
  - `ADMIN_USER_IDS` (опционально для `/upload`)
- TODO: [STATUS: TODO] Реализовать `src/app/config.py`:
  - загрузка `.env` через `python-dotenv` (только локально),
  - валидация обязательных переменных,
  - безопасный вывод конфигурации в логи (без ключей).
- TODO: [STATUS: TODO] Создать `src/app/main.py` и корректный запуск под контейнер:
  - **НЕ использовать `asyncio.run()`**,
  - вызывать `application.run_polling()` или `application.run_webhook()` напрямую (python-telegram-bot управляет event loop самостоятельно),
  - добавить graceful shutdown (по сигналам, если нужно).
- TODO: [STATUS: TODO] Реализовать базового бота:
  - `/start` приветствие,
  - `/help` краткая справка,
  - `/cancel` сброс состояния сессии.
- TODO: [STATUS: TODO] Добавить простое in-memory хранилище состояния пользователя (словарь по `user_id`) в `src/app/storage/memory_store.py` + интерфейс `StateStore`.
- TODO: [STATUS: TODO] Добавить smoke-тест: запуск бота локально (polling), команда `/start` отвечает.

---

## Milestone 2 — Excel-пайплайн: категории, фильтрация, подготовка данных для LLM

- TODO: [STATUS: TODO] Реализовать `src/app/data/excel_reader.py`:
  - чтение Excel из `EXCEL_PATH`,
  - нормализация типов (в т.ч. `Ранг` как строка/число),
  - проверка наличия обязательных колонок: `Фича`, `Год`, `Показатель`, `Значение`, `Ранг`, `Проект`, `Продукт`,
  - поддержка колонки `Категория` (если есть).
- TODO: [STATUS: TODO] Реализовать `src/app/data/categories.py`:
  - функция `list_categories(df)`: вернуть уникальные значения из `Категория`, иначе из `Продукт`,
  - функция `filter_by_categories(df, selected)`: вернуть только строки выбранных категорий.
- TODO: [STATUS: TODO] Реализовать `src/app/data/topic_filtering.py` (локальная подготовка выборки):
  - фильтровать строки по выбранным категориям,
  - передавать в LLM **весь набор строк**, а не “сжатую” статистику (чтобы выводы строились только на данных),
  - опционально: ограничение на максимальное число строк и стратегия chunking (см. Milestone 3).
- TODO: [STATUS: TODO] Добавить утилиту сериализации данных в компактный текст:
  - CSV/TSV без лишних полей,
  - обязательно включать нужные колонки,
  - экранировать переносы строк в `Фича`.
- TODO: [STATUS: TODO] Добавить диагностический скрипт `scripts/print_categories.py`:
  - читает Excel,
  - печатает количество строк и список категорий,
  - пригодно для CI/smoke и для дебага на Railway.
- TODO: [STATUS: TODO] Добавить тесты (минимум):
  - валидируются обязательные колонки,
  - корректно определяется список категорий,
  - фильтрация возвращает ожидаемое число строк.

---

## Milestone 3 — Интеграция OpenAI (GPT‑5.2), промпты, генерация отчета и “repair”

- TODO: [STATUS: TODO] Создать директорию `prompts/` и файлы:
  - `prompts/feature_summary_prompt.md` (основной шаблон с `{topic}`, `{selected_categories}`, `{data}`),
  - `prompts/repair_prompt.md` (шаблон для единственной попытки исправить формат).
- TODO: [STATUS: TODO] Реализовать `src/app/services/openai_client.py`:
  - инициализация OpenAI SDK из `OPENAI_API_KEY`,
  - параметризация модели через `OPENAI_MODEL`,
  - таймауты, ретраи на сетевые ошибки,
  - логирование request-id/длительности без утечек данных.
- TODO: [STATUS: TODO] Реализовать `src/app/services/report_generator.py`:
  - подготовка данных (категории → df → tsv/csv),
  - сбор финального промпта,
  - запрос в OpenAI,
  - проверка базовых инвариантов ответа (наличие “выводов” и “саммари” по структуре),
  - при несоответствии — 1 попытка “repair” (тот же исходный материал + repair prompt),
  - возвращать итоговый текст для отправки в Telegram.
- TODO: [STATUS: TODO] Реализовать chunking для больших выборок:
  - разбиение по `Проект` (предпочтительно) или по `Год`,
  - генерация промежуточных саммари по чанкам,
  - финальный объединяющий запрос: агрегированные выводы + единое детальное саммари,
  - гарантировать, что финальный текст основан только на промежуточных саммари/данных (никаких внешних источников).
- TODO: [STATUS: TODO] Добавить лимиты и защиту от чрезмерной нагрузки:
  - максимум строк на один запрос,
  - максимум проектов,
  - сообщение пользователю, если выборка слишком большая (с предложением сузить категории/тему).
- TODO: [STATUS: TODO] Интегрировать генерацию в бота:
  - шаг 1: спросить тему (и показать примеры),
  - шаг 2: показать список категорий (inline-кнопки, multi-select),
  - шаг 3: кнопка “Сгенерировать”,
  - шаг 4: отправка результата (при необходимости — несколькими сообщениями, учитывая лимит Telegram).
- TODO: [STATUS: TODO] Добавить наблюдаемость:
  - логи по этапам (excel load, filter, openai calls, chunking),
  - метрики в логах (кол-во строк/проектов, время).

---

## Milestone 4 — Деплой (GitHub + Railway), Docker, прод-режим webhook

- TODO: [STATUS: TODO] Создать `Dockerfile` на базе `python:3.12-slim`.

  **ВАЖНО: Порядок операций критичен для editable install:**
  1) `COPY pyproject.toml ./`  
  2) `COPY src/ ./src/`  **# ОБЯЗАТЕЛЬНО перед `pip install -e .`**  
  3) `RUN pip install --no-cache-dir -e .`

  Дополнительно:
  - установить системные зависимости при необходимости (`build-essential` только если нужно),
  - использовать non-root пользователя (желательно).
- TODO: [STATUS: TODO] Создать `.dockerignore` для оптимизации контекста (исключить `.git/`, `.venv/`, `__pycache__/`, `tests/`, локальные данные, если не нужны).
- TODO: [STATUS: TODO] Настроить Railway:
  - сервис из GitHub,
  - переменные окружения,
  - порт `PORT` (Railway),
  - режим webhook: `BOT_MODE=webhook`, `WEBHOOK_URL=<public-url>`.
- TODO: [STATUS: TODO] Реализовать webhook-конфигурацию:
  - путь `/webhook`,
  - установка webhook при старте (если `WEBHOOK_URL` задан),
  - корректная обработка healthcheck (например `/health`).
- TODO: [STATUS: TODO] Добавить CI (минимум):
  - линт/формат,
  - запуск тестов,
  - smoke: импорт пакета и запуск скрипта `print_categories.py` на примере файла (если хранится в репо) или мок.
- TODO: [STATUS: TODO] Документировать релиз:
  - как обновлять Excel (через переменную `EXCEL_PATH` или `/upload` в будущем),
  - как откатывать,
  - как смотреть логи и типовые ошибки.

---

# Acceptance Checklist

- [ ] Репозиторий содержит корректную структуру каталогов и описан в `README.md`.
- [ ] `.gitignore` создан **до первого коммита** и исключает `.env`/секреты.
- [ ] Локальный запуск работает (polling): `/start` → тема → категории → “Сгенерировать” → ответ.
- [ ] Категории выводятся из колонки `Категория` (или fallback на `Продукт`) и совпадают с данными Excel.
- [ ] Генерация строится **строго по данным Excel** (никаких внешних источников/статистики).
- [ ] Ответ соответствует формату: сначала 3–5 буллитов выводов с доказательствами, затем детальное саммари по проектам с рангами.
- [ ] Реализован chunking (или понятное ограничение) для больших выборок и безопасные лимиты.
- [ ] Docker-образ собирается; Railway деплой успешен.
- [ ] В webhook-режиме бот стабильно обрабатывает запросы; `asyncio.run()` не используется.
- [ ] Логи не содержат секретов; есть базовая диагностика по этапам.
- [ ] Тесты покрывают чтение Excel, категории, фильтрацию (минимальный набор).

> **@Cursor**: После завершения задачи поменяй её статус на DONE и добавь краткий маркер «// done by Cursor» с описанием, что именно сделано.
