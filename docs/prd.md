# PRD: Telegram-бот для агрегированного саммари результатов тестов фичей (GPT-5.2 + Excel)

## 1. Overview / Problem
У продуктовой команды есть один Excel-файл с результатами тестов фичей (ранги фичей в проектах, метрики, годы, продукт/категория и т.д.). Нужно быстро получать:
- **агрегированные выводы** (3–5 буллитов) о том, какие типы фичей по заданной теме обычно оцениваются выше/ниже;
- **детальное саммари** по всем проектам, где встречаются фичи, релевантные заданной теме, строго по структуре из промпта.

Сейчас это делается вручную: фильтрация по теме и категории, группировка по проектам, выписывание рангов, затем ручное обобщение. Это занимает много времени и дает неустойчивое качество формулировок.

Цель: сделать Telegram-бота, который по запросу пользователя формирует финальный текст “выводы + саммари” **только на основании одного Excel-файла** и **строго по заданному промпту**.

## 2. Key User Flows

### Flow A: Основной сценарий (MVP)
1. Пользователь вводит `/start`.
2. Бот спрашивает: **“По какой теме агрегировать?”** и показывает примеры: `Качество звука`, `Wellbeing`, `Умный дом`.
3. Пользователь вводит тему (текстом).
4. Бот спрашивает: **“Какие категории интересуют?”** и показывает список категорий, извлеченных из Excel по колонке **`Категория`** (или fallback на `Продукт`, если `Категория` отсутствует).
5. Пользователь выбирает одну или несколько категорий (кнопками).
6. Бот:
   - валидирует файл/колонки,
   - формирует контекст для LLM (с учетом ограничений по токенам),
   - вызывает OpenAI API (GPT-5.2) с пользовательским промптом,
   - возвращает ответ в Telegram: сначала **агрегированные выводы**, затем **детальное саммари**.

### Flow B: Ошибки данных / валидация
- Если нет нужных колонок → бот объясняет, каких колонок не хватает (с точными названиями) и завершает сценарий.
- Если выбранная категория не имеет строк → бот сообщает и предлагает выбрать другую категорию.
- Если LLM-ответ не соответствует ожидаемой структуре → бот делает 1 автопопытку “repair” (переформатирование по структуре), затем возвращает пользователю максимально полезный результат с пометкой о частичном несоответствии.

### Flow C: Администрирование файла (минимально)
- MVP: файл фиксирован и лежит на сервере (в репозитории или примонтирован в Railway), путь задается env-переменной.
- Post-MVP: команда `/upload` (доступна только admin) для загрузки нового Excel в чат-бот и замены текущего источника данных.

## 3. Functional Requirements

### 3.1. Интеграция с Telegram
- Поддержка команд: `/start`, `/help`, `/cancel`.
- Использование inline-кнопок:
  - выбор категорий (multi-select),
  - кнопка “Сгенерировать”,
  - кнопка “Начать заново”.
- Хранение состояния диалога на пользователя (in-memory + опционально Redis на Railway).

### 3.2. Источник данных: один Excel-файл
**Обязательное требование:** выводы строятся только на основании данных из одного Excel-файла.

**Поддерживаемые колонки (минимум):**
- `Фича`
- `Год`
- `Показатель`
- `Значение`
- `Ранг`
- `Проект`
- `Продукт` (или `Категория` — см. ниже)

**Колонка категорий для выбора пользователем:**
- Основная: `Категория`
- Fallback: если `Категория` отсутствует, использовать `Продукт` как список категорий.

**Правила обработки:**
- Чтение Excel (pandas/openpyxl).
- Приведение типов:
  - `Ранг` → число (если возможно), иначе строка, но сохранять исходное значение.
- Нормализация пропусков: пустые/NaN в ключевых колонках не участвуют в генерации.

### 3.3. Сбор доступных категорий
- При старте диалога бот формирует список уникальных значений из колонки `Категория` (или `Продукт` при fallback).
- Список сортируется (алфавитно) и отображается кнопками (постранично, если > 20–30 значений).

### 3.4. Подготовка данных для LLM
Чтобы обеспечить “только по данным файла” и контролировать стоимость/токены:

**MVP-подход:**
- После выбора категорий бот **фильтрует строки локально** по выбранным категориям (по `Категория` или `Продукт` в зависимости от источника списка).
- В LLM отправляется:
  - системные инструкции (роль/стиль),
  - пользовательский промпт-шаблон (предоставленный),
  - **табличные данные по отфильтрованным строкам** в компактном формате (например CSV/TSV в тексте).

**Ограничения по размеру:**
- Если отфильтрованные строки превышают лимит по токенам:
  - стратегия “chunking”:
    1) разбить данные по проектам (`Проект`) или по годам,
    2) получить промежуточные саммари по чанкам,
    3) финальный вызов: агрегировать выводы + объединить саммари в едином формате.
- Во всех шагах запрещено добавлять внешние знания; бот не подмешивает никакие другие источники.

### 3.5. Вызов OpenAI API (GPT-5.2)
- Конфигурируемая модель через env: `OPENAI_MODEL` (по умолчанию `gpt-5.2`).
- Таймауты и ретраи (например 1–2 ретрая при сетевых ошибках).
- Логи:
  - идентификатор запроса,
  - объем входных данных (кол-во строк/проектов),
  - длительность,
  - ошибки (без сохранения чувствительных данных и ключей).

### 3.6. Промпт и формат ответа
- Промпт хранится как шаблон (файл в репозитории), с подстановками:
  - `{topic}` — тема пользователя,
  - `{selected_categories}` — выбранные категории/продукты,
  - `{data}` — таблица данных.
- Ответ бота должен быть в формате:
  1) **общие выводы** (3–5 буллитов, с доказательствами в скобках: ранг/из скольких/в каком тесте),
  2) затем **детальное саммари** строго по структуре (группировка по Год+Проект+Продукт+Показатель, “Ранг из X фич”, и строки фич с проставленным рангом).

### 3.7. Безопасность и приватность
- Ключи OpenAI и Telegram — только в env переменных Railway.
- Бот не сохраняет исходный Excel в логах.
- Если реализован `/upload`, файл хранится только на сервере/диске Railway и не пересылается куда-либо кроме OpenAI API в рамках генерации (и только нужные строки/подмножество данных).

## 4. Non-Goals
- Поддержка нескольких Excel-файлов и объединение источников.
- Подтягивание внешних данных (рынок, конкуренты, “best practices”, исследования).
- Автоматическая интерпретация метрик “Значение” как универсально сравнимых — опора только на ранги, как в промпте.
- UI вне Telegram (веб-кабинет, дашборд).
- Сложная RBAC/корпоративная авторизация (кроме простого admin-списка для `/upload`).
- Нотификации/подписки/периодическая рассылка.

## 5. Milestones & Release Plan

### Milestone 0 — Setup (1–2 дня)
- Репозиторий GitHub, базовая структура проекта.
- Railway проект + env переменные (`TELEGRAM_BOT_TOKEN`, `OPENAI_API_KEY`, `OPENAI_MODEL`, `EXCEL_PATH`, `ADMIN_USER_IDS`).
- Базовый бот “ping”.

### Milestone 1 — MVP диалог + чтение Excel (3–5 дней)
- `/start` → вопрос темы → выбор категории из файла → подтверждение.
- Парсер Excel + валидация колонок.
- Отправка данных в LLM + возврат результата в Telegram.

### Milestone 2 — Устойчивость и качество (3–5 дней)
- Chunking для больших выборок.
- Авто-ремонт форматирования ответа (1 попытка).
- Логи и метрики (кол-во строк/проектов, ошибки).

### Milestone 3 — Post-MVP (опционально, 3–7 дней)
- `/upload` для admin.
- Кэширование распарсенного файла и списка категорий.
- Экспорт результата в файл (Markdown/Doc) и отправка документом в Telegram.
